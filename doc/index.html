<html>

<head>
  <title>Wabbit</title>
  <link href="style.css" rel="stylesheet" type="text/css">

  <a href="https://github.com/vmlaker/wabbit"><img style="position: fixed; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>

</head>

<body>

  <div class="main_block">

    <div style="float: left;">
      <h1>Wabbit</h1>
    </div>

    <div style="float: left;">
      <div class="logo">
        <image src="logo.png"/>
      </div>
    </div>

    <div style="clear: left;">
    </div>

    <p>
      Wabbit is a scalable webcam recording system.
      Takes continuous snapshots, stores images on disk 
      and maintains database index.

      <div class="demo_link">
        <a href="http://vmlaker.org/wabbit">&nbsp;live demo&nbsp;</a>
      </div>
    </p>

    <p>
      C++ multithreading for image processing.
      Minimalist RESTful API written
      in Python with
      <a href="http://flask.pocoo.org">Flask</a>.
      Example JavaScript surveillance application.
    </p>

    <h2>Table of Contents</h2>
    <ul>
      <li><a href="#download">Download</a></li>
      <li><a href="#install">Install</a></li>
      <li><a href="#configure">Configure</a></li>
      <li><a href="#deploy">Deploy</a></li>
      <li><a href="#faq">FAQ</a></li>
      <li><a href="#about">About</a></li>
    </ul>

    <h2 id="download">Download</h2>
    
    <p>
      Start by getting code from two repos:
      <ol>
        <li><a href="http://vmlaker.github.io/bites">Bites</a>,
          a small C++ utility library, and
        </li>
        <li>the
          <a href="http://github.com/vmlaker/wabbit">Wabbit</a>
          code repo (comes with 
          <a href="http://vmlaker.github.io/coils">Coils</a>
          git submodule):
        </li>
      </ol>
    </p>

    <div class="code_block">
      git clone https://github.com/vmlaker/bites
      git clone --recursive https://github.com/vmlaker/wabbit
      cd wabbit
    </div>

    <h2 id="install">Install</h2>

    <p>
      From here, build the software stack.
      Follow any error trail and install missing 
      pieces using your system's package manager.
      Like, if missing C++ bindings for MySQL,
      just get the Aptitude package <code>libmysql++-dev</code>
      or YUM package <code>mysql++-devel</code>.
      Then repeat the step.
    </p>

    <p>
      First run make -- it builds a Python virtualenv instance
      and node environment, and compiles the web client.
    </p>

    <div class="code_block">
      make
    </div>

    <p>
      Second, prepare the main C++ build by installing ODB libraries
      using the provided shell script.
      (Try <code>./install-odb.sh --help</code> for details.)
    </p>

    <div class="code_block">
      ./install-odb.sh
    </div>
    
    <p>
      Third, run the compiler chain via SCons:
    </p>

    <div class="code_block">
      scons bites=../bites
    </div>

    <h2 id="configure">Configure</h2>

    <p>
      Customize your installation by editing file <code>wabbit.cfg</code>.
      Check all settings, and set the path settings to absolute paths 
      on your system.
    </p>
    <p>
      Then create the database, tables, user and privileges
      (you're gonna need to know your MySQL admin password):
    </p>

    <div class="code_block">
      venv/bin/python src/create.py
    </div>

    <p>
      If later you want to undo changes to your MySQL,
      run <code>venv/bin/python src/drop.py</code>.
      This will remove (clean up) everything created by the previous command.
    </p>

    <p>
      Now test your configuration by running the recorder and pruner:
    </p>

    <div class="code_block">
      bin/record 10
      venv/bin/python src/dump.py
      venv/bin/python src/prune.py -60
      venv/bin/python src/dump.py
    </div>

    <p>
      Now run the server:
    </p>
    
    <div class="code_block">
      venv/bin/gunicorn src.serve:app -b 127.0.0.1:8000
    </div>

    <p>
      Go to 
      <a href="http:127.0.0.1:8000/info">http:127.0.0.1:8000/info</a> 
      to check the server.
    </p>
    
    <h2 id="deploy">Deploy</h2>

    <p>
      Now we'll deploy to the Apahche HTTPD web server. 
      The following copies all client code to your Apache's 
      <code>DocumentRoot</code> directory
      (in this case being <code>/var/www/html/wabbit</code> ):
    </p>

    <div class="code_block">
      sudo rm -rf /var/www/html/wabbit
      sudo venv/bin/python src/deploy.py /var/www/html/wabbit
    </div>

    <p>
      The second command above dumps a snippet for
      Apache VirtualHost configuration &mdash;
      cut-and-paste the snippet into your server's Apache conf file.
      Then restart the server:
    </p>
      
    <div class="code_block">
      sudo systemctl restart httpd.service
    </div>

    <p>
      Your page is visible at 
      <a href="http://localhost/wabbit">http://localhost/wabbit</a>.
    </p>

    <p>
      If you're running SELinux, 
      keep in mind that default security policies may forbid 
      HTTPD from reading your pictures directory
      (as configured with <code>pics_dir</code> variable in file <code>wabbit.cfg</code>).
      If that's the case, 
      change the SELinux security context of the path:
    </p>

    <div class="code_block">
      sudo chcon -R -t httpd_sys_content_t /path/to/pics
    </div>

    <p>
      Recorder and pruner can be automated
      by scheduling them as cron jobs. 
      An example crontab file <code>wabbit.cron</code> is provided
      as a starting point for your custom setup.
      Gunicorn can be automated with upstart or Systemd.
    </p>

    <h2 id="faq">FAQ</h2>

    <ol>

      <li>
        <p>
          Q: When I run make, I get
          <code>EnvironmentError: mysql_config not found</code>.
        </p>
        <p>
          A: You're missing <code>mysql_config</code>.
          On Ubuntu, install the missing package:
          <div class="code_block">
            sudo apt-get install libmysqlclient-dev
          </div>
        </p>
      </li>

      <li>
        <p>
          Q: When I run SCons, I get an error like this:
          <p>
            <code>configure: error: g++ does not support plugins; reconfigure GCC with --enable-plugin</code>
          </p>
        </p>
        <p>
          A: Your GCC is missing header files for plugin development.
          On Ubuntu, install the needed package:
          <div class="code_block">
            sudo apt-get install gcc-4.8-plugin-dev
          </div>
        </p>
      </li>

      <li>
        <p>
          Q: When I attempt to record snapshots, I get
          <code>Cannot open device -1.</code> error.
        </p>
        <p>
          A: Your webcam is not detected. 
          Check by making sure your system has a webcam:
          <div class="code_block">
            ls /dev/video*
          </div>
        </p>
      </li>

      <li>
        <p>
          Q: When I attempt to record snapshots, 
          I get the following error:
        </p>
        <p>
          <code>
            Can't connect to local MySQL server through socket '/var/run/mysqld/mysqld.sock'
          </code>
        </p>
        <p>
          A: Your MySQL server is probably not running,
          or perhaps not even installed.
          On Ubuntu, install and start the server with:
          <div class="code_block">
            sudo apt-get install mysql-server
            sudo service mysql start
          </div>
        </p>
      </li>

      <li>
        <p>
          Q: When I attempt to record snapshots, 
          I get the following error:
        </p>
        <p>
          <code>
            Access denied for user 'bugs'@'localhost' (using password: YES)
          </code>
        </p>
        <p>
          A: You probably forgot to create your database.
          Try running:
          <div class="code_block">
            python src/create.py
          </div>
        </p>
        <p>
          (See <a href="#usage">Usage</a> for more details.)
        </p>
      </li>

      <li>
        <p>
          Q: When I try to compile client-side pages, I get:
        </p>
        <p>
          <code>
            /usr/bin/env: node: No such file or directory
          </code>
        </p>
        <p>
          A: You probably installed node from a package manager,
          and it is misnamed to <code>nodejs</code> instead of <code>node</code>.
          Fix this by symlinking the executable:
          <div class="code_block">
            sudo ln -s /usr/bin/nodejs /usr/bin/node
          </div>
        </p>
      </li>

    </ol>

    <h2 id="about">About</h2>

    <p>
      Author Velimir Mlaker. 
      C++ build configured with
      <a href="http://www.scons.org">SCons</a>.
      Camera interaction with
      <a href="http://docs.opencv.org">OpenCV</a>.
      DB accessed with ORM.
      <a href="http://www.codesynthesis.com/products/odb">ODB</a>
      for C++. 
      <a href="http://www.sqlalchemy.org">SQLAlchemy</a> 
      for Python.
      Database engine: MySQL.
      Web app using 
      <a href="http://flask.pocoo.org">Flask</a>.
      Client written in
      <a href="http://jade-lang.com">Jade</a> and
      <a href="http://coffeescript.org">CoffeeScript</a>.
      <a href="http://jquery.org">jQuery</a> for AJAX.
    </p>

    <div class="footer">
      This page is built with 
      <a href="http://www.w3.org/html">HTML</a> and 
      <a href="http://www.w3.org/style/css">CSS</a>.
    </div>

  </div> <!-- class="main_block" -->

</body>

</html>
