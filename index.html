<html>

<head>
  <title>Wabbit</title>
  <link href="style.css" rel="stylesheet" type="text/css">

  <a href="https://github.com/vmlaker/wabbit"><img style="position: fixed; top: 0; right: 0; border: 0;" src="forkme.png" alt="Fork me on GitHub"></a>

</head>

<body>
  <div class="main_block">

    <div class="preamble_top">
      <div class="logo" style="float:right;">
        <image src="logo.png"/>
      </div>
      <div class="title">Wabbit</div>
      <p>
        Distributed webcam surveillance
        with snapshot capture and image processing.
        Web API access to database and archive.
      </p>
    </div> <!-- preamble_top -->

    <div class="preamble_bot">
      multithreading
      &middot;
      image processing with OpenCV
      &middot;
      Python and C++ server
      &middot;
      RESTful API with Flask
      &middot;
      JS client
      <p>
        <div class="demo_link">
          <a href="http://vmlaker.org/wabbit">
            &nbsp;Click here for live demo !&nbsp;
          </a>
        </div>
      </p>
    </div>
      
    <div class="spacing"></div>

    <h2>Table of Contents</h2>
    <ul>
      <li><a href="#download">Download</a></li>
      <li><a href="#install">Install</a></li>
      <li><a href="#configure">Configure</a></li>
      <li><a href="#deploy">Deploy</a></li>
      <li><a href="#faq">FAQ</a></li>
      <li><a href="#about">The stack</a></li>
    </ul>

    <h2 id="download">Download</h2>
    
    <p>
      Get code from two repos,
      <ol>
        <li><a href="http://vmlaker.github.io/bites">Bites</a>,
          a small C++ utility library and
        </li>
        <li>the
          <a href="http://github.com/vmlaker/wabbit">Wabbit</a>
          code repo (comes with 
          <a href="http://vmlaker.github.io/coils">Coils</a>
          git submodule):
        </li>
      </ol>
    </p>

    <div class="code_block">
      git clone https://github.com/vmlaker/bites
      git clone --recursive https://github.com/vmlaker/wabbit
      cd wabbit
    </div>

    <h2 id="install">Install</h2>

    <p>
      Run make to build a Python virtualenv instance
      and node environment, and to compile the client:
    </p>

    <div class="code_block">
      make
    </div>

    <p>
      Then run a script to install C++ ODB libraries
      (use <code>--help</code> for details):
    </p>

    <div class="code_block">
      ./install-odb.sh
    </div>
    
    <p>
      Finally run the SCons compiler chain:
    </p>

    <div class="code_block">
      scons bites=../bites
    </div>

    <h2 id="configure">Configure</h2>

    <p>
      Customize your installation by editing file 
      <code>wabbit.cfg</code>&mdash;set all path settings
      to absolute paths on your system.
    </p>
    <p>
      Then create the database user and privileges
      (you will need to know your MySQL root password):
    </p>

    <div class="code_block">
      venv/bin/python src/create.py
    </div>

    <p>
      If later you want to undo the above command,
      run <code>venv/bin/python src/drop.py</code>
      to clean up what was created.
    </p>

    <p>
      Now you can test the Recorder and Pruner:
    </p>

    <div class="code_block">
      bin/record 10
      venv/bin/python src/dump.py
      venv/bin/python src/prune.py -60
      venv/bin/python src/dump.py
    </div>

    <p>
      Next run the server:
    </p>
    
    <div class="code_block">
      venv/bin/gunicorn src.serve:app -b 127.0.0.1:8000
    </div>

    <p>
      Go to 
      <a href="http://127.0.0.1:8000/info">http://127.0.0.1:8000/info</a> 
      to check the API server.
    </p>
    
    <h2 id="deploy">Deploy</h2>

    <p>
      Deploy to Apache HTTPD by
      copying client stack to
      <code>DocumentRoot</code>
      (in this case <code>/var/www/html/wabbit</code>):
    </p>

    <div class="code_block">
      sudo rm -rf /var/www/html/wabbit
      sudo venv/bin/python src/deploy.py /var/www/html/wabbit
    </div>

    <p>
      That second command dumps a snippet for
      your VirtualHost configuration&mdash;cut 'n paste
      the snippet into your Apache conf file.
    </p>

    <p>
      Then restart your server:
    </p>
      
    <div class="code_block">
      sudo systemctl restart httpd.service
    </div>

    <p>
      Your page is visible at 
      <a href="http://localhost/wabbit">http://localhost/wabbit</a>.
    </p>

    <p>
      If running SELinux, 
      security policies may forbid 
      HTTPD from reading your pictures directory.
      In that case change your SELinux security context of your pics dir:
    </p>

    <div class="code_block">
      sudo chcon -R -t httpd_sys_content_t /path/to/my/pics
    </div>

    <p>
      Automate your Recorder and Pruner
      by scheduling them as cron jobs. 
      See file <code>wabbit.cron</code> for an example setup.
      Gunicorn can be automated with upstart or Systemd.
    </p>

    <h2 id="faq">FAQ</h2>

    <ol>

      <li>
        <p>
          <b>Q:</b> 
          When I run make, I get
          <code>EnvironmentError: mysql_config not found</code>.
          What do I do?
          <br><br>
          <b>A:</b> 
          You're missing <code>mysql_config</code>.
          On Ubuntu, install the missing package:
          <div class="code_block">
            sudo apt-get install libmysqlclient-dev
          </div>
        </p>
      </li>

      <br>

      <li>
        <p>
          <b>Q:</b> 
          How do I install C++ bindings for MySQL?
          <br><br>
          <b>A:</b> 
          With Aptitude get the <code>libmysql++-dev</code> package.
          Or, with YUM get <code>mysql++-devel</code>.
        </p>
      </li>

      <br>

      <li>
        <p>
          <b>Q:</b> 
          When I run SCons, I get an error like this:
          <code>configure: error: g++ does not support plugins; reconfigure GCC with --enable-plugin</code>.
          What does this mean?
          <br><br>
          <b>A:</b> 
          Your GCC is missing header files for plugin development.
          On Ubuntu, install the needed package:
          <div class="code_block">
            sudo apt-get install gcc-4.8-plugin-dev
          </div>
        </p>
      </li>

      <br>

      <li>
        <p>
          <b>Q:</b> 
          When I attempt to record snapshots, I get
          <code>Cannot open device -1</code> error.
          Why is this happening?
          <br><br>
          <b>A:</b> Your webcam is not detected. 
          Check by making sure your system has a webcam:
          <div class="code_block">
            ls /dev/video*
          </div>
        </p>
      </li>

      <br>

      <li>
        <p>
          <b>Q:</b> 
          When I attempt to record snapshots, I get the error
          <code>Can't connect to local MySQL server through socket '/var/run/mysqld/mysqld.sock'</code>.
          What gives?
          <br><br>
          <b>A:</b> 
          Your MySQL server is probably not running,
          or perhaps not even installed.
          On Ubuntu, install and start the server with:
          <div class="code_block">
            sudo apt-get install mysql-server
            sudo service mysql start
          </div>
        </p>
      </li>

      <br>

      <li>
        <p>
          <b>Q:</b> 
          When I attempt to record snapshots, I get the error
          <code>Access denied for user 'bugs'@'localhost' (using password: YES)</code>.
          Please help!
          <br><br>
          <b>A:</b> 
          You most likely forgot to create the database.
          Try running:
          <div class="code_block">
            python src/create.py
          </div>
        </p>
        <p>
          (See the <a href="#configure">Configure</a> section for more details.)
        </p>
      </li>

      <br>

      <li>
        <p>
          <b>Q:</b> 
          When I try to compile client-side pages, I get
          <code>/usr/bin/env: node: No such file or directory</code>.
          What gives?
          <br><br>
          <b>A:</b> 
          You probably installed node from a package manager,
          and it is misnamed to <code>nodejs</code> instead of <code>node</code>.
          Fix this by symlinking the executable:
          <div class="code_block">
            sudo ln -s /usr/bin/nodejs /usr/bin/node
          </div>
        </p>
      </li>

    </ol>

    <h2 id="about">The stack</h2>

    <p>
      A brief rundown of the software stack used in creating Wabbit:
      <i>
      <ul>
        <li><a href="http://www.scons.org">SCons</a> for C++ build</li>
        <li><a href="http://docs.opencv.org">OpenCV</a> for camera access</li>
        <li><a href="http://www.codesynthesis.com/products/odb">ODB</a> for C++ ORM</li>
        <li><a href="http://www.sqlalchemy.org">SQLAlchemy</a> for Python ORM</li>
        <li>MySQL for RDBMS</li>
        <li><a href="http://flask.pocoo.org">Flask</a> for web app</li>
        <li><a href="http://jade-lang.com">Jade</a> and
          <a href="http://coffeescript.org">CoffeeScript</a> for the client</li>
        <li><a href="http://jquery.org">jQuery</a> for AJAX</li>
      </ul>
      </i>
    </p>

    <div class="footer">
      This page is built with 
      <a href="http://www.w3.org/html">HTML</a> and 
      <a href="http://www.w3.org/style/css">CSS</a>.
    </div>

  </div> <!-- class="main_block" -->

</body>

</html>
