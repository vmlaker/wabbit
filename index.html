<html>

<head>
  <title>Wabbit</title>
  <link href="style.css" rel="stylesheet" type="text/css">

  <a href="https://github.com/vmlaker/wabbit"><img style="position: fixed; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>

</head>

<body>

  <div class="main_block">

    <div style="float: left;">
      <h1>Wabbit</h1>
    </div>

    <div style="float: left;">
      <div class="logo">
        <image src="logo.png"/>
      </div>
    </div>

    <div style="clear: left;">
    </div>

    <p>
      At its core, Wabbit is a webcam recording system. 
      It takes continuous snapshots, stores images on disk 
      and maintains the archive index in a relational database.
      The package comes with a web app for displaying snapshots 
      and browsing the image archive.

      <div class="demo_link">
        <a href="http://vmlaker.org/wabbit">Check out the live demo at http://vmlaker.org/wabbit !</a>
      </div>
    </p>

    <p>
      The pipelined multi-threaded processing of captured images
      is written in C++.
      It's designed so you can easily add your own 
      image processing, archiving or analysis stages:
      simply write your custom thread and plug it into the worklow.
    </p>

    <p>
      The minimalist RESTful API server is written
      in a Python microframework.
      The basic functions are included, but the API is easy to build on
      to add your own interfaces.
    </p>

    <p>
      With elementary components already in place 
      &mdash; capture, archive, management and access &mdash;
      Wabbit is a scalable platform 
      perfect for development of active video surveillance systems.
    </p>
    
    <h2>Table of Contents</h2>
    <ul>
      <li><a href="#installation">Installation</a></li>
      <li><a href="#usage">Usage</a></li>
      <li><a href="#deployment">Deployment</a></li>
      <li><a href="#faq">FAQ</a></li>
    </ul>

    <h2 id="installation">Installation</h2>

    <p>
      The build chain &mdash; for compiling the C++ parts &mdash; is configured using
      <a href="http://www.scons.org">SCons</a>.
      Camera interaction runs on
      <a href="http://docs.opencv.org">OpenCV</a>
      and database is accessed with object-relational mapping using
      <a href="http://www.codesynthesis.com/products/odb">ODB</a>
      (for C++) and
      <a href="http://www.sqlalchemy.org">SQLAlchemy</a> 
      (for Python).
      The database engine is MySQL.
      The web app itself is powered by 
      <a href="http://flask.pocoo.org">Flask</a>.
      Static pages are written in
      <a href="http://jade-lang.com">Jade</a>
      and client-side scripts in
      <a href="http://coffeescript.org">CoffeeScript</a>.
      The <a href="http://jquery.org">jQuery</a> library calls AJAX.
    </p>
    
    <p>
      Start by getting code from two repos:
      <ol>
        <li><a href="http://vmlaker.github.io/bites">Bites</a>,
          a small C++ utility library, and
        </li>
        <li>the
          <a href="http://github.com/vmlaker/wabbit">Wabbit</a>
          code repo (which actually clones an additional, third repo
          <a href="http://vmlaker.github.io/coils">Coils</a>
          as a Git submodule):
        </li>
      </ol>
    </p>

    <div class="code_block">
      git clone https://github.com/vmlaker/bites
      git clone --recursive https://github.com/vmlaker/wabbit
      cd wabbit
    </div>

    <p>
      From here, build the software stack.
      Although installation of all 3rd-party requirements
      is not documented, you're probably best off simply
      following any error trail and installing missing 
      pieces using your system's package manager.
      For example, if missing C++ bindings for MySQL,
      just get the Aptitude package <code>libmysql++-dev</code>
      or YUM package <code>mysql++-devel</code>.
      Then repeat the step.
    </p>

    <p>
      Now then, for the Python side of things,
      let's build a Python virtual environment using
      the provided Makefile. 
      As part of the build, make runs <code>virtualenv</code>,
      configuring the environment according to <code>requirements.txt</code> spec:
    </p>

    <div class="code_block">
      make
      make test
    </div>

    <p>
      For the C++ parts, first install ODB using the provided shell script.
      (Try <code>./install-odb.sh --help</code> for details.)
    </p>

    <div class="code_block">
      ./install-odb.sh
    </div>

    </p>
      Then run the compiler chain via SCons:
    </p>

    <div class="code_block">
      scons bites=../bites
    </div>

    <h2 id="usage">Usage</h2>

    <p>
      Customize your configuration by editing file <code>wabbit.cfg</code>.
      Check all settings in the file, particularly the database settings.
      Also, make sure all directories are set as absolute paths.
    </p>
    <p>
      Then create the database, tables, user and privileges
      (you're gonna need to know your MySQL admin password):
    </p>

    <div class="code_block">
      python src/create.py
    </div>

    <p>
      If, at a later time, you want to undo changes to your MySQL,
      run <code>python src/drop.py</code>.
      This will remove (clean up) everything created by the previous command.
    </p>

    <p>
      With the database initialized, you can now test the recorder and pruner:
    </p>

    <div class="code_block">
      bin/record 10
      python src/dump.py
      python src/prune.py -60
      python src/dump.py
    </div>

    <h2 id="deployment">Deployment</h2>

    <p>
      First thing, compile the client-side pages and scripts:
    </p>

    <div class="code_block">
      npm install jade coffee-script
      node_modules/.bin/jade --pretty -o templates/ src/*.jade
      node_modules/.bin/coffee -o static -c src/*.coffee
    </div>

    <p>
      Before deploying to your Apache server, check your Wabbit configuration file 
      <code>wabbit.cfg</code> -- be sure that the pics destination setting 
      <code>pics</code> is a complete path to a valid directory.
    </p>
    <p>
      Then, deploy to your web server. For Apache HTTPD just run the following
      (assuming your <code>DocumentRoot</code> is <code>/var/www/html</code>):
    </p>

    <div class="code_block">
      sudo rm -rf /var/www/html/wabbit
      sudo python src/deploy.py /var/www/html/wabbit
    </div>

    <p>
      The second command above dumps a configuration snippet for HTTPD.
      Cut-and-paste the snippet into your HTTPD .conf file.
      Then restart the server:
    </p>
      
    <div class="code_block">
      sudo systemctl restart httpd.service
    </div>

    <p>
      If you're running SELinux, 
      keep in mind that default security policies may forbid 
      HTTPD from reading your pictures directory
      (as configured with <code>pics_dir</code> variable in file <code>wabbit.cfg</code>).
      If that's the case, 
      change the SELinux security context of the path:
    </p>

    <div class="code_block">
      sudo chcon -R -t httpd_sys_content_t /path/to/pics
    </div>

    <p>
      Your page is visible at 
      <a href="http://localhost/wabbit">http://localhost/wabbit</a>.
    </p>

    <p>
      Consider automating the recorder and pruner 
      by scheduling them as cron jobs. 
      An example crontab file <code>wabbit.cron</code> is provided
      as a starting point for your custom setup.
    </p>

    <h2 id="faq">FAQ</h2>

    <ol>

      <li>
        <p>
          Q: When I run make, I get
          <code>EnvironmentError: mysql_config not found</code>.
        </p>
        <p>
          A: You're missing <code>mysql_config</code>.
          On Ubuntu, install the missing package:
          <div class="code_block">
            sudo apt-get install libmysqlclient-dev
          </div>
        </p>
      </li>

      <li>
        <p>
          Q: When I run SCons, I get an error like this:
          <p>
            <code>configure: error: g++ does not support plugins; reconfigure GCC with --enable-plugin</code>
          </p>
        </p>
        <p>
          A: Your GCC is missing header files for plugin development.
          On Ubuntu, install the needed package:
          <div class="code_block">
            sudo apt-get install gcc-4.8-plugin-dev
          </div>
        </p>
      </li>

      <li>
        <p>
          Q: When I attempt to record snapshots, I get
          <code>Cannot open device -1.</code> error.
        </p>
        <p>
          A: Your webcam is not detected. 
          Check by making sure your system has a webcam:
          <div class="code_block">
            ls /dev/video*
          </div>
        </p>
      </li>

      <li>
        <p>
          Q: When I attempt to record snapshots, 
          I get the following error:
        </p>
        <p>
          <code>
            Can't connect to local MySQL server through socket '/var/run/mysqld/mysqld.sock'
          </code>
        </p>
        <p>
          A: Your MySQL server is probably not running,
          or perhaps not even installed.
          On Ubuntu, install and start the server with:
          <div class="code_block">
            sudo apt-get install mysql-server
            sudo service mysql start
          </div>
        </p>
      </li>

      <li>
        <p>
          Q: When I attempt to record snapshots, 
          I get the following error:
        </p>
        <p>
          <code>
            Access denied for user 'bugs'@'localhost' (using password: YES)
          </code>
        </p>
        <p>
          A: You probably forgot to create your database.
          Try running:
          <div class="code_block">
            python src/create.py
          </div>
        </p>
        <p>
          (See <a href="#usage">Usage</a> for more details.)
        </p>
      </li>

      <li>
        <p>
          Q: When I try to compile client-side pages, I get:
        </p>
        <p>
          <code>
            /usr/bin/env: node: No such file or directory
          </code>
        </p>
        <p>
          A: You probably installed node from a package manager,
          and it is misnamed to <code>nodejs</code> instead of <code>node</code>.
          Fix this by symlinking the executable:
          <div class="code_block">
            sudo ln -s /usr/bin/nodejs /usr/bin/node
          </div>
        </p>
      </li>

    </ol>

    <div class="footer">
      This page is built with 
      <a href="http://www.w3.org/html">HTML</a> and 
      <a href="http://www.w3.org/style/css">CSS</a>.
    </div>

  </div> <!-- class="main_block" -->

</body>

</html>
